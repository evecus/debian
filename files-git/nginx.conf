user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log off;
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    gzip on;

    server {
        listen 8080;
        server_name _;
        charset utf-8;

        # 健康检查
        location = /healthz {
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }

        # 最后同步时间
        location = /__last_update__ {
            alias /data/.last_update;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Cache-Control "no-store";
        }

        # 同步状态：文件存在返回内容（同步中），不存在返回 404
        location = /__syncing__ {
            alias /data/.syncing;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Cache-Control "no-store";
            add_header Access-Control-Allow-Origin * always;
        }

        # 禁止访问其他隐藏文件（__ 开头的特殊路由已在上面单独处理）
        location ~ /\. {
            deny all;
        }

        # JSON 目录列表 API
        location ^~ /__api__/ {
            alias /data/files/;
            autoindex on;
            autoindex_format json;
            autoindex_exact_size on;
            add_header Access-Control-Allow-Origin * always;
            add_header Cache-Control "no-store" always;
        }

        # 原始文件内容（强制 text/plain，供前端预览）
        location ^~ /__raw__/ {
            alias /data/files/;
            add_header Content-Type "text/plain; charset=utf-8" always;
            add_header Access-Control-Allow-Origin * always;
        }

        # 直接访问文件路径 → 原始内容（wget/curl 用）
        location / {
            root /data/files;
            try_files $uri @ui;
        }

        # 目录或不存在路径 → 前端页面
        location @ui {
            root /app;
            try_files /index.html =404;
        }
    }
}
