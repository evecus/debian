<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>rules_set</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Noto+Sans+SC:wght@300;400;500&display=swap');

:root {
  --bg: #0d1117;
  --bg2: #161b22;
  --bg3: #21262d;
  --border: #30363d;
  --text: #e6edf3;
  --text2: #8b949e;
  --accent: #58a6ff;
  --accent2: #1f6feb;
  --green: #3fb950;
  --folder: #e3b341;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'Noto Sans SC', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  font-weight: 300;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* â”€â”€ Header â”€â”€ */
header {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  height: 56px;
  display: flex;
  align-items: center;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  font-family: var(--mono);
  font-weight: 600;
  font-size: 15px;
  color: var(--text);
  text-decoration: none;
  cursor: pointer;
}
.logo span { color: var(--accent); }

.sync-info {
  margin-left: auto;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 6px;
}
.dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

/* â”€â”€ Layout â”€â”€ */
main {
  max-width: 960px;
  width: 100%;
  margin: 32px auto;
  padding: 0 24px;
  flex: 1;
}

/* â”€â”€ Breadcrumb â”€â”€ */
.breadcrumb {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--text2);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
}
.breadcrumb .crumb {
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
}
.breadcrumb .crumb:hover { text-decoration: underline; }
.breadcrumb .sep { color: var(--border); margin: 0 2px; }
.breadcrumb .current { color: var(--text); }

/* â”€â”€ File list â”€â”€ */
.file-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.file-box-header {
  padding: 11px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  color: var(--text2);
  font-family: var(--mono);
  display: flex;
  justify-content: space-between;
}
.file-row {
  display: grid;
  grid-template-columns: 26px 1fr 90px;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  transition: background .1s;
  cursor: pointer;
}
.file-row:last-child { border-bottom: none; }
.file-row:hover { background: var(--bg3); }
.file-row .icon { font-size: 15px; text-align: center; }
.file-row .name {
  font-size: 14px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.file-row .name:hover { color: var(--accent); }
.file-row .size {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text2);
  text-align: right;
}
.back-row .name { color: var(--text2); }

/* â”€â”€ Preview panel â”€â”€ */
.preview-wrap {
  display: none;
  flex-direction: column;
}
.preview-wrap.active { display: flex; }

.preview-header {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px 8px 0 0;
  padding: 11px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}
.preview-meta {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--text2);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.preview-meta strong { color: var(--text); }

.btn-group { display: flex; gap: 8px; flex-shrink: 0; }
.btn {
  font-family: var(--mono);
  font-size: 12px;
  padding: 5px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  transition: all .15s;
  background: var(--bg3);
  color: var(--text);
}
.btn:hover { background: var(--border); }
.btn-primary {
  background: var(--accent2);
  color: #fff;
  border-color: var(--accent);
}
.btn-primary:hover { background: var(--accent); }

.code-wrap {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 8px 8px;
  overflow: auto;
  max-height: 75vh;
}
.line-table {
  border-collapse: collapse;
  width: 100%;
  font-family: var(--mono);
  font-size: 13px;
  line-height: 1.6;
}
.ln {
  width: 1%;
  min-width: 48px;
  padding: 0 14px 0 16px;
  text-align: right;
  color: var(--text2);
  border-right: 1px solid var(--border);
  user-select: none;
  vertical-align: top;
  white-space: nowrap;
}
.lc {
  padding: 0 16px;
  white-space: pre;
  color: var(--text);
  vertical-align: top;
}
tr:hover .ln { color: var(--text); }
tr:hover { background: rgba(255,255,255,.025); }

.loading {
  padding: 48px;
  text-align: center;
  color: var(--text2);
  font-family: var(--mono);
  font-size: 13px;
}
.binary-notice {
  padding: 48px;
  text-align: center;
  color: var(--text2);
}
.binary-notice .big { font-size: 40px; margin-bottom: 12px; }

/* â”€â”€ Toast â”€â”€ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 16px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text);
  opacity: 0;
  transform: translateY(8px);
  transition: all .2s;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body>

<header>
  <span class="logo" onclick="navigate('')">rules<span>_set</span></span>
  <div class="sync-info">
    <div class="dot"></div>
    <span id="last-update">åŠ è½½ä¸­...</span>
  </div>
</header>

<main>
  <div class="breadcrumb" id="breadcrumb"></div>

  <!-- ç›®å½•åˆ—è¡¨ -->
  <div class="file-box" id="dir-view"></div>

  <!-- æ–‡ä»¶é¢„è§ˆ -->
  <div class="preview-wrap" id="preview-wrap">
    <div class="preview-header">
      <div class="preview-meta" id="preview-meta"></div>
      <div class="btn-group">
        <button class="btn" onclick="backToDir()">â† è¿”å›</button>
        <a class="btn btn-primary" id="dl-btn" download>â¬‡ ä¸‹è½½</a>
      </div>
    </div>
    <div class="code-wrap" id="code-wrap"></div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const TEXT_EXTS = new Set([
  'yaml','yml','json','toml','txt','conf','list','ini','cfg',
  'md','sh','py','js','ts','html','css','xml','go','rs','log',
  'env','properties','lock','gitignore','editorconfig'
]);

let currentPath = '';   // å½“å‰ç›®å½•è·¯å¾„ï¼ˆç›¸å¯¹äºæ ¹ï¼Œä¸å«å‰åæ–œæ ï¼‰
let currentFile = null; // å½“å‰é¢„è§ˆçš„æ–‡ä»¶è·¯å¾„

// â”€â”€ è¯»å–æœ€ååŒæ­¥æ—¶é—´ â”€â”€
fetch('/__api__/.last_update_meta', {cache:'no-store'})
  .catch(()=>{});

// ç”¨å¦ä¸€ç§æ–¹å¼è¯»åŒæ­¥æ—¶é—´ï¼šé€šè¿‡ç‰¹æ®Šæ¥å£
async function loadLastUpdate() {
  try {
    const r = await fetch('/healthz');
    // healthzåªæ˜¯æµ‹æ´»ï¼ŒåŒæ­¥æ—¶é—´é€šè¿‡metaæ–‡ä»¶è¯»
  } catch(e){}
}

// ä» /data/.last_update è¯»å–ï¼ˆé€šè¿‡ç‰¹æ®Šnginxè·¯ç”±æš´éœ²ï¼‰
async function fetchLastUpdate() {
  try {
    const r = await fetch('/__last_update__', {cache:'no-store'});
    if (r.ok) {
      const t = await r.text();
      document.getElementById('last-update').textContent = 'æœ€ååŒæ­¥ï¼š' + t.trim();
    }
  } catch(e) {
    document.getElementById('last-update').textContent = 'æœ€ååŒæ­¥ï¼šæœªçŸ¥';
  }
}
fetchLastUpdate();

// â”€â”€ å·¥å…·å‡½æ•° â”€â”€
function ext(name) {
  const i = name.lastIndexOf('.');
  return i >= 0 ? name.slice(i+1).toLowerCase() : '';
}

function isText(name) {
  return TEXT_EXTS.has(ext(name));
}

function humanSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1024/1024).toFixed(1) + ' MB';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// â”€â”€ é¢åŒ…å±‘ â”€â”€
function renderBreadcrumb(path) {
  const parts = path ? path.split('/') : [];
  let html = '<span class="crumb" onclick="navigate(\'\')">root</span>';
  let acc = '';
  parts.forEach((p, i) => {
    acc += (acc ? '/' : '') + p;
    const a = acc;
    html += '<span class="sep">/</span>';
    if (i === parts.length - 1 && currentFile) {
      html += `<span class="current">${p}</span>`;
    } else {
      html += `<span class="crumb" onclick="navigate('${a}')">${p}</span>`;
    }
  });
  document.getElementById('breadcrumb').innerHTML = html;
}

// â”€â”€ ç›®å½•åŠ è½½ â”€â”€
async function navigate(path) {
  currentPath = path;
  currentFile = null;

  // åˆ‡æ¢æ˜¾ç¤º
  document.getElementById('dir-view').style.display = '';
  document.getElementById('preview-wrap').classList.remove('active');

  renderBreadcrumb(path);

  const apiPath = '/__api__/' + (path ? path + '/' : '');
  document.getElementById('dir-view').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

  try {
    const r = await fetch(apiPath, {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const entries = await r.json();

    const dirs  = entries.filter(e => e.type === 'directory').sort((a,b) => a.name.localeCompare(b.name));
    const files = entries.filter(e => e.type === 'file').sort((a,b) => a.name.localeCompare(b.name));

    let rows = '';

    // è¿”å›ä¸Šçº§
    if (path) {
      const parent = path.includes('/') ? path.slice(0, path.lastIndexOf('/')) : '';
      rows += `<div class="file-row back-row" onclick="navigate('${parent}')">
        <div class="icon">ğŸ“‚</div>
        <div class="name">..</div>
        <div class="size">â€”</div>
      </div>`;
    }

    dirs.forEach(e => {
      const child = path ? path + '/' + e.name : e.name;
      rows += `<div class="file-row" onclick="navigate('${child}')">
        <div class="icon" style="color:var(--folder)">ğŸ“</div>
        <div class="name">${e.name}</div>
        <div class="size">â€”</div>
      </div>`;
    });

    files.forEach(e => {
      const filePath = path ? path + '/' + e.name : e.name;
      rows += `<div class="file-row" onclick="openFile('${filePath}', ${e.size})">
        <div class="icon">ğŸ“„</div>
        <div class="name">${e.name}</div>
        <div class="size">${humanSize(e.size)}</div>
      </div>`;
    });

    const total = `${dirs.length} ä¸ªç›®å½•ï¼Œ${files.length} ä¸ªæ–‡ä»¶`;
    document.getElementById('dir-view').innerHTML = `
      <div class="file-box-header">
        <span>/${path || ''}</span>
        <span>${total}</span>
      </div>
      ${rows}`;

  } catch(e) {
    document.getElementById('dir-view').innerHTML =
      `<div class="loading">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
  }
}

// â”€â”€ æ–‡ä»¶é¢„è§ˆ â”€â”€
async function openFile(filePath, size) {
  currentFile = filePath;

  const parts = filePath.split('/');
  const name = parts[parts.length - 1];
  const dirPath = parts.slice(0, -1).join('/');

  document.getElementById('dir-view').style.display = 'none';
  document.getElementById('preview-wrap').classList.add('active');

  renderBreadcrumb(filePath);

  const dlUrl = '/' + filePath;
  document.getElementById('dl-btn').href = dlUrl;
  document.getElementById('dl-btn').download = name;
  document.getElementById('preview-meta').innerHTML =
    `<span style="color:var(--text2)">${dirPath ? dirPath + '/' : ''}</span><strong>${name}</strong>` +
    `<span style="color:var(--text2);margin-left:12px">${humanSize(size)}</span>`;

  const codeWrap = document.getElementById('code-wrap');

  if (!isText(name)) {
    // äºŒè¿›åˆ¶ï¼šæç¤ºä¸‹è½½ï¼Œè§¦å‘æµè§ˆå™¨ä¸‹è½½
    codeWrap.innerHTML = `<div class="binary-notice">
      <div class="big">ğŸ“¦</div>
      äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<a href="${dlUrl}" download style="color:var(--accent)">ç‚¹å‡»ä¸‹è½½</a>
    </div>`;
    // è‡ªåŠ¨è§¦å‘ä¸‹è½½
    const a = document.createElement('a');
    a.href = dlUrl; a.download = name; a.click();
    return;
  }

  codeWrap.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

  try {
    const r = await fetch('/__raw__/' + filePath, {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const text = await r.text();
    const lines = text.split('\n');

    let rows = '';
    lines.forEach((line, i) => {
      const escaped = line
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
      rows += `<tr><td class="ln">${i+1}</td><td class="lc">${escaped}</td></tr>`;
    });

    codeWrap.innerHTML = `<table class="line-table"><tbody>${rows}</tbody></table>`;
  } catch(e) {
    codeWrap.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
  }
}

function backToDir() {
  const dirPath = currentFile
    ? currentFile.includes('/')
      ? currentFile.slice(0, currentFile.lastIndexOf('/'))
      : ''
    : currentPath;
  navigate(dirPath);
}

// åˆå§‹åŒ–
navigate('');
</script>
</body>
</html>
